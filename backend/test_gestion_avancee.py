#!/usr/bin/env python3
"""
Test du syst√®me de gestion avanc√©e ComptaEBNL-IA
Teste dirigeants, projets, budget, activit√©s, patrimoine, balance multi-projets/bailleurs
"""

import sys
import os
from datetime import datetime, date, timedelta
from decimal import Decimal

# Ajouter le dossier src au path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

try:
    from flask import Flask
    from flask_sqlalchemy import SQLAlchemy
    from models_gestion import *
    print("‚úÖ Import des mod√®les de gestion avanc√©e r√©ussi")
except ImportError as e:
    print(f"‚ùå Erreur d'import: {e}")
    print("Assurez-vous d'avoir install√© les d√©pendances: pip install flask flask-sqlalchemy pandas")
    sys.exit(1)

# Configuration de l'application de test
app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///test_gestion_avancee.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)

def init_test_data():
    """Initialise les donn√©es de test"""
    print("\nüìä INITIALISATION DONN√âES DE TEST")
    print("-" * 40)
    
    # Cr√©er les tables
    db.create_all()
    
    # Cr√©er une association de test (simul√©e)
    association_id = 1
    
    # Cr√©er des bailleurs de test
    bailleurs_data = [
        {
            'nom': 'Agence Fran√ßaise de D√©veloppement',
            'sigle': 'AFD',
            'type_bailleur': TypeBailleur.GOUVERNEMENT,
            'pays_origine': 'France',
            'contact_nom': 'Jean MARTIN',
            'contact_email': 'j.martin@afd.fr'
        },
        {
            'nom': 'Fondation Gates',
            'sigle': 'BMGF',
            'type_bailleur': TypeBailleur.FONDATION,
            'pays_origine': 'USA',
            'contact_nom': 'Sarah JOHNSON',
            'contact_email': 's.johnson@gatesfoundation.org'
        },
        {
            'nom': 'Union Europ√©enne - D√©l√©gation Burkina',
            'sigle': 'UE-BF',
            'type_bailleur': TypeBailleur.UNION_EUROPEENNE,
            'pays_origine': 'Belgique',
            'contact_nom': 'Marie DUBOIS',
            'contact_email': 'm.dubois@eeas.europa.eu'
        }
    ]
    
    bailleurs = []
    for data in bailleurs_data:
        bailleur = Bailleur(**data)
        db.session.add(bailleur)
        bailleurs.append(bailleur)
    
    db.session.flush()
    print(f"‚úÖ {len(bailleurs)} bailleurs cr√©√©s")
    
    return association_id, bailleurs

def test_dirigeants(association_id):
    """Test de la gestion des dirigeants"""
    print("\nüë• TESTS DIRIGEANTS")
    print("-" * 30)
    
    dirigeants_data = [
        {
            'nom': 'OUEDRAOGO',
            'prenoms': 'Aminata',
            'type_dirigeant': TypeDirigeant.PRESIDENT,
            'date_nomination': date(2023, 1, 15),
            'date_naissance': date(1975, 8, 20),
            'nationalite': 'Burkinab√®',
            'profession': 'Enseignante',
            'telephone': '+226 70 12 34 56',
            'email': 'a.ouedraogo@association.bf',
            'pouvoir_signature': True,
            'pouvoir_engagement': True,
            'seuil_engagement': Decimal('5000000')  # 5M FCFA
        },
        {
            'nom': 'SAWADOGO',
            'prenoms': 'Ibrahim',
            'type_dirigeant': TypeDirigeant.TRESORIER,
            'date_nomination': date(2023, 1, 15),
            'date_naissance': date(1980, 3, 10),
            'nationalite': 'Burkinab√®',
            'profession': 'Comptable',
            'telephone': '+226 70 98 76 54',
            'email': 'i.sawadogo@association.bf',
            'pouvoir_signature': True,
            'pouvoir_engagement': False,
            'seuil_engagement': Decimal('2000000')  # 2M FCFA
        },
        {
            'nom': 'KONE',
            'prenoms': 'Fatoumata',
            'type_dirigeant': TypeDirigeant.SECRETAIRE_GENERAL,
            'date_nomination': date(2023, 1, 15),
            'date_naissance': date(1982, 11, 5),
            'nationalite': 'Burkinab√®',
            'profession': 'Juriste',
            'telephone': '+226 70 55 44 33',
            'email': 'f.kone@association.bf',
            'pouvoir_signature': False,
            'pouvoir_engagement': False
        }
    ]
    
    dirigeants = []
    for data in dirigeants_data:
        dirigeant = Dirigeant(association_id=association_id, **data)
        db.session.add(dirigeant)
        dirigeants.append(dirigeant)
    
    db.session.flush()
    
    for dirigeant in dirigeants:
        print(f"‚úÖ Dirigeant: {dirigeant.prenoms} {dirigeant.nom} - {dirigeant.type_dirigeant.value}")
        print(f"   üìû {dirigeant.telephone} | ‚úâÔ∏è {dirigeant.email}")
        print(f"   üñäÔ∏è Signature: {'Oui' if dirigeant.pouvoir_signature else 'Non'}")
        print(f"   üí∞ Engagement: {dirigeant.seuil_engagement if dirigeant.pouvoir_engagement else 'Non'} FCFA")
    
    return dirigeants

def test_projets(association_id, bailleurs):
    """Test de la gestion des projets"""
    print("\nüöÄ TESTS PROJETS MULTI-BAILLEURS")
    print("-" * 40)
    
    projets_data = [
        {
            'code_projet': 'EDUC-BF-2024-001',
            'titre': 'Am√©lioration de l\'√©ducation rurale au Burkina Faso',
            'description': 'Projet visant √† am√©liorer l\'acc√®s et la qualit√© de l\'√©ducation dans les zones rurales',
            'date_debut': date(2024, 1, 1),
            'date_fin': date(2026, 12, 31),
            'budget_total': Decimal('2500000000'),  # 2.5 milliards FCFA
            'bailleur_id': bailleurs[0].id,  # AFD
            'contribution_bailleur': Decimal('2000000000'),
            'contribution_association': Decimal('500000000'),
            'chef_projet': 'Dr. Aminata OUEDRAOGO',
            'coordinateur': 'Ibrahim SAWADOGO',
            'pays': 'Burkina Faso'
        },
        {
            'code_projet': 'SANTE-BF-2024-002',
            'titre': 'Renforcement du syst√®me de sant√© communautaire',
            'description': 'Am√©lioration de l\'acc√®s aux soins de sant√© primaires en milieu rural',
            'date_debut': date(2024, 3, 1),
            'date_fin': date(2027, 2, 28),
            'budget_total': Decimal('1800000000'),  # 1.8 milliards FCFA
            'bailleur_id': bailleurs[1].id,  # Gates Foundation
            'contribution_bailleur': Decimal('1600000000'),
            'contribution_association': Decimal('200000000'),
            'chef_projet': 'Dr. Fatoumata KONE',
            'coordinateur': 'Moussa TRAORE',
            'pays': 'Burkina Faso'
        },
        {
            'code_projet': 'AGRI-BF-2024-003',
            'titre': 'D√©veloppement agricole durable',
            'description': 'Promotion de techniques agricoles durables et r√©silientes au climat',
            'date_debut': date(2024, 6, 1),
            'date_fin': date(2028, 5, 31),
            'budget_total': Decimal('3200000000'),  # 3.2 milliards FCFA
            'bailleur_id': bailleurs[2].id,  # Union Europ√©enne
            'contribution_bailleur': Decimal('2800000000'),
            'contribution_association': Decimal('400000000'),
            'chef_projet': 'Ing. Boureima ZONGO',
            'coordinateur': 'Salimata OUATTARA',
            'pays': 'Burkina Faso'
        }
    ]
    
    projets = []
    for data in projets_data:
        projet = Projet(association_id=association_id, **data)
        # Calculer la dur√©e
        delta = projet.date_fin - projet.date_debut
        projet.duree_mois = round(delta.days / 30)
        projet.statut = StatutProjet.EN_COURS
        db.session.add(projet)
        projets.append(projet)
    
    db.session.flush()
    
    for projet in projets:
        # R√©cup√©rer le bailleur manuellement
        bailleur = next((b for b in bailleurs if b.id == projet.bailleur_id), None)
        print(f"‚úÖ Projet: {projet.code_projet}")
        print(f"   üìù {projet.titre}")
        print(f"   üèõÔ∏è Bailleur: {bailleur.nom if bailleur else 'N/A'}")
        print(f"   üí∞ Budget: {float(projet.budget_total):,.0f} FCFA")
        print(f"   üìÖ Dur√©e: {projet.duree_mois} mois ({projet.date_debut} ‚Üí {projet.date_fin})")
        print(f"   üë®‚Äçüíº Chef: {projet.chef_projet}")
        print()
    
    return projets

def test_budgets(association_id, projets):
    """Test de la gestion budg√©taire"""
    print("\nüí∞ TESTS BUDGETS MULTI-PROJETS")
    print("-" * 40)
    
    # Cr√©er un budget pour le premier projet
    projet = projets[0]
    
    budget = Budget(
        association_id=association_id,
        projet_id=projet.id,
        libelle=f"Budget {projet.code_projet} - Exercice 2024",
        exercice=2024,
        date_debut=date(2024, 1, 1),
        date_fin=date(2024, 12, 31),
        commentaires="Budget pr√©visionnel premi√®re ann√©e"
    )
    
    db.session.add(budget)
    db.session.flush()
    
    # Ajouter des lignes de budget d√©taill√©es
    lignes_budget = [
        # RECETTES
        {
            'categorie': 'Recettes',
            'sous_categorie': 'Subventions',
            'libelle': 'Subvention AFD - Tranche 1',
            'compte_comptable': '7013',
            'montant_prevu': Decimal('800000000'),
            'ordre_affichage': 1
        },
        {
            'categorie': 'Recettes',
            'sous_categorie': 'Contributions',
            'libelle': 'Contribution propre association',
            'compte_comptable': '7018',
            'montant_prevu': Decimal('200000000'),
            'ordre_affichage': 2
        },
        # D√âPENSES
        {
            'categorie': 'Depenses',
            'sous_categorie': 'Personnel',
            'libelle': 'Salaires √©quipe projet',
            'compte_comptable': '6411',
            'montant_prevu': Decimal('300000000'),
            'ordre_affichage': 3
        },
        {
            'categorie': 'Depenses',
            'sous_categorie': 'Mat√©riel',
            'libelle': '√âquipements p√©dagogiques',
            'compte_comptable': '6022',
            'montant_prevu': Decimal('400000000'),
            'ordre_affichage': 4
        },
        {
            'categorie': 'Depenses',
            'sous_categorie': 'Fonctionnement',
            'libelle': 'Frais de d√©placement et missions',
            'compte_comptable': '6251',
            'montant_prevu': Decimal('150000000'),
            'ordre_affichage': 5
        },
        {
            'categorie': 'Depenses',
            'sous_categorie': 'Formation',
            'libelle': 'Formation des enseignants',
            'compte_comptable': '6228',
            'montant_prevu': Decimal('150000000'),
            'ordre_affichage': 6
        }
    ]
    
    for ligne_data in lignes_budget:
        ligne = LigneBudget(budget_id=budget.id, **ligne_data)
        db.session.add(ligne)
    
    db.session.flush()
    
    # Calculer les totaux
    budget.total_recettes_prevues = sum(
        ligne.montant_prevu for ligne in budget.lignes_budget 
        if ligne.categorie == 'Recettes'
    )
    budget.total_depenses_prevues = sum(
        ligne.montant_prevu for ligne in budget.lignes_budget 
        if ligne.categorie == 'Depenses'
    )
    
    print(f"‚úÖ Budget cr√©√©: {budget.libelle}")
    print(f"   üìä Recettes pr√©vues: {float(budget.total_recettes_prevues):,.0f} FCFA")
    print(f"   üìä D√©penses pr√©vues: {float(budget.total_depenses_prevues):,.0f} FCFA")
    print(f"   ‚öñÔ∏è √âquilibre: {float(budget.total_recettes_prevues - budget.total_depenses_prevues):,.0f} FCFA")
    print(f"   üìã Lignes budg√©taires: {len(budget.lignes_budget)}")
    
    print("\nüìã D√âTAIL DES LIGNES BUDG√âTAIRES:")
    for ligne in budget.lignes_budget:
        print(f"   {ligne.categorie} | {ligne.sous_categorie} | {ligne.libelle}")
        print(f"      üí∞ {float(ligne.montant_prevu):,.0f} FCFA (Compte {ligne.compte_comptable})")
    
    return [budget]

def test_activites(association_id, projets):
    """Test de la gestion des activit√©s"""
    print("\nüéØ TESTS ACTIVIT√âS PAR PROJET")
    print("-" * 40)
    
    # Activit√©s pour le projet √©ducation
    projet_educ = projets[0]
    activites_educ = [
        {
            'code_activite': 'EDUC-001',
            'titre': 'Formation des enseignants ruraux',
            'description': 'Formation p√©dagogique pour 200 enseignants',
            'type_activite': TypeActivite.FORMATION,
            'date_debut_prevue': date(2024, 2, 1),
            'date_fin_prevue': date(2024, 3, 31),
            'lieu': 'Ouagadougou',
            'region': 'Centre',
            'nombre_participants_prevu': 200,
            'budget_alloue': Decimal('50000000'),
            'responsable_activite': 'Dr. Aminata OUEDRAOGO'
        },
        {
            'code_activite': 'EDUC-002',
            'titre': 'Construction de salles de classe',
            'description': 'Construction de 50 salles de classe en zones rurales',
            'type_activite': TypeActivite.DEVELOPPEMENT,
            'date_debut_prevue': date(2024, 4, 1),
            'date_fin_prevue': date(2024, 12, 31),
            'lieu': 'Provinces rurales',
            'region': 'Multi-r√©gions',
            'nombre_participants_prevu': 2500,  # √âl√®ves b√©n√©ficiaires
            'budget_alloue': Decimal('400000000'),
            'responsable_activite': 'Ing. Boureima ZONGO'
        }
    ]
    
    # Activit√©s pour le projet sant√©
    projet_sante = projets[1]
    activites_sante = [
        {
            'code_activite': 'SANTE-001',
            'titre': 'Formation agents de sant√© communautaire',
            'description': 'Formation de 150 agents de sant√© communautaire',
            'type_activite': TypeActivite.FORMATION,
            'date_debut_prevue': date(2024, 4, 1),
            'date_fin_prevue': date(2024, 5, 31),
            'lieu': 'Centres de sant√© ruraux',
            'region': 'Multi-r√©gions',
            'nombre_participants_prevu': 150,
            'budget_alloue': Decimal('30000000'),
            'responsable_activite': 'Dr. Fatoumata KONE'
        },
        {
            'code_activite': 'SANTE-002',
            'titre': 'Campagne de sensibilisation',
            'description': 'Sensibilisation sur l\'hygi√®ne et la pr√©vention',
            'type_activite': TypeActivite.SENSIBILISATION,
            'date_debut_prevue': date(2024, 6, 1),
            'date_fin_prevue': date(2024, 8, 31),
            'lieu': 'Villages ruraux',
            'region': 'Multi-r√©gions',
            'nombre_participants_prevu': 5000,
            'budget_alloue': Decimal('25000000'),
            'responsable_activite': 'Salimata OUATTARA'
        }
    ]
    
    toutes_activites = []
    
    # Cr√©er les activit√©s du projet √©ducation
    for data in activites_educ:
        activite = Activite(
            association_id=association_id,
            projet_id=projet_educ.id,
            **data
        )
        db.session.add(activite)
        toutes_activites.append(activite)
    
    # Cr√©er les activit√©s du projet sant√©
    for data in activites_sante:
        activite = Activite(
            association_id=association_id,
            projet_id=projet_sante.id,
            **data
        )
        db.session.add(activite)
        toutes_activites.append(activite)
    
    db.session.flush()
    
    # Afficher les activit√©s par projet
    for projet in [projet_educ, projet_sante]:
        print(f"\nüìã Activit√©s du projet: {projet.titre}")
        activites_projet = [a for a in toutes_activites if a.projet_id == projet.id]
        for activite in activites_projet:
            print(f"   ‚úÖ {activite.code_activite}: {activite.titre}")
            print(f"      üìÖ {activite.date_debut_prevue} ‚Üí {activite.date_fin_prevue}")
            print(f"      üìç {activite.lieu} ({activite.region})")
            print(f"      üë• {activite.nombre_participants_prevu} participants")
            print(f"      üí∞ {float(activite.budget_alloue):,.0f} FCFA")
            print(f"      üë®‚Äçüíº Responsable: {activite.responsable_activite}")
    
    return toutes_activites

def test_patrimoine(association_id, projets):
    """Test de la gestion du patrimoine"""
    print("\nüèõÔ∏è TESTS PATRIMOINE ET BIENS")
    print("-" * 40)
    
    biens_data = [
        {
            'libelle': 'V√©hicule de mission Toyota Hilux',
            'description': 'V√©hicule 4x4 pour missions terrain',
            'type_bien': TypeBien.VEHICULE,
            'marque': 'Toyota',
            'modele': 'Hilux Double Cabine',
            'numero_serie': 'TH2024BF001',
            'valeur_acquisition': Decimal('25000000'),  # 25M FCFA
            'valeur_actuelle': Decimal('22000000'),
            'date_acquisition': date(2024, 1, 15),
            'date_mise_service': date(2024, 1, 20),
            'localisation': 'Si√®ge Ouagadougou',
            'responsable_bien': 'Ibrahim SAWADOGO',
            'duree_amortissement_annees': 5,
            'projet_id': projets[0].id  # Li√© au projet √©ducation
        },
        {
            'libelle': 'Ordinateurs portables HP',
            'description': 'Lot de 20 ordinateurs portables pour formation',
            'type_bien': TypeBien.EQUIPEMENT_INFORMATIQUE,
            'marque': 'HP',
            'modele': 'ProBook 450 G9',
            'valeur_acquisition': Decimal('20000000'),  # 20M FCFA
            'valeur_actuelle': Decimal('18000000'),
            'date_acquisition': date(2024, 2, 1),
            'date_mise_service': date(2024, 2, 5),
            'localisation': 'Centre de formation',
            'responsable_bien': 'Fatoumata KONE',
            'duree_amortissement_annees': 3,
            'projet_id': projets[0].id
        },
        {
            'libelle': '√âquipements m√©dicaux mobiles',
            'description': 'Kit m√©dical pour consultations mobiles',
            'type_bien': TypeBien.EQUIPEMENT_TECHNIQUE,
            'marque': 'MedEquip',
            'modele': 'Mobile Health Kit Pro',
            'valeur_acquisition': Decimal('15000000'),  # 15M FCFA
            'valeur_actuelle': Decimal('14000000'),
            'date_acquisition': date(2024, 3, 1),
            'date_mise_service': date(2024, 3, 10),
            'localisation': 'Centre de sant√© mobile',
            'responsable_bien': 'Dr. Fatoumata KONE',
            'duree_amortissement_annees': 7,
            'projet_id': projets[1].id  # Li√© au projet sant√©
        },
        {
            'libelle': 'G√©n√©rateur √©lectrique',
            'description': 'G√©n√©rateur de secours 15 KVA',
            'type_bien': TypeBien.EQUIPEMENT_TECHNIQUE,
            'marque': 'Caterpillar',
            'modele': 'DE15E0',
            'numero_serie': 'CAT2024BF001',
            'valeur_acquisition': Decimal('8000000'),  # 8M FCFA
            'valeur_actuelle': Decimal('7500000'),
            'date_acquisition': date(2024, 1, 10),
            'date_mise_service': date(2024, 1, 15),
            'localisation': 'Si√®ge Ouagadougou',
            'responsable_bien': 'Moussa TRAORE',
            'duree_amortissement_annees': 10
        }
    ]
    
    biens = []
    for i, data in enumerate(biens_data, 1):
        # Auto-g√©n√©rer le num√©ro d'inventaire
        year = datetime.now().year
        numero_inventaire = f"BN-{year}-{i:04d}"
        
        bien = Bien(
            association_id=association_id,
            numero_inventaire=numero_inventaire,
            **data
        )
        
        # Calculer l'amortissement si applicable
        if bien.duree_amortissement_annees and bien.date_acquisition:
            # Calcul simple : amortissement lin√©aire
            mois_ecoules = (datetime.now().date() - bien.date_acquisition).days / 30
            if mois_ecoules > 0:
                amortissement_mensuel = bien.valeur_acquisition / (bien.duree_amortissement_annees * 12)
                bien.valeur_amortie = min(
                    amortissement_mensuel * mois_ecoules,
                    bien.valeur_acquisition
                )
        
        db.session.add(bien)
        biens.append(bien)
    
    db.session.flush()
    
    # Affichage des biens par projet
    biens_par_projet = {}
    biens_generaux = []
    
    for bien in biens:
        if bien.projet_id:
            if bien.projet_id not in biens_par_projet:
                biens_par_projet[bien.projet_id] = []
            biens_par_projet[bien.projet_id].append(bien)
        else:
            biens_generaux.append(bien)
    
    # Biens par projet
    for projet_id, biens_projet in biens_par_projet.items():
        projet = next(p for p in projets if p.id == projet_id)
        print(f"\nüìã Biens du projet: {projet.code_projet}")
        for bien in biens_projet:
            print(f"   ‚úÖ {bien.numero_inventaire}: {bien.libelle}")
            print(f"      üè∑Ô∏è {bien.marque} {bien.modele}")
            print(f"      üí∞ Acquisition: {float(bien.valeur_acquisition):,.0f} FCFA")
            print(f"      üìà Actuelle: {float(bien.valeur_actuelle):,.0f} FCFA")
            print(f"      üìç Localisation: {bien.localisation}")
            print(f"      üë®‚Äçüíº Responsable: {bien.responsable_bien}")
    
    # Biens g√©n√©raux
    if biens_generaux:
        print(f"\nüìã Biens g√©n√©raux de l'association:")
        for bien in biens_generaux:
            print(f"   ‚úÖ {bien.numero_inventaire}: {bien.libelle}")
            print(f"      üí∞ Valeur: {float(bien.valeur_actuelle):,.0f} FCFA")
            print(f"      üìç {bien.localisation}")
    
    # Statistiques patrimoine
    valeur_totale = sum(bien.valeur_actuelle or bien.valeur_acquisition for bien in biens)
    print(f"\nüìä STATISTIQUES PATRIMOINE:")
    print(f"   üèõÔ∏è Nombre total de biens: {len(biens)}")
    print(f"   üí∞ Valeur totale du patrimoine: {float(valeur_totale):,.0f} FCFA")
    
    return biens

def test_financements(association_id, projets, bailleurs):
    """Test de la gestion des financements"""
    print("\nüí∏ TESTS FINANCEMENTS MULTI-BAILLEURS")
    print("-" * 50)
    
    financements_data = [
        {
            'projet_id': projets[0].id,
            'bailleur_id': bailleurs[0].id,  # AFD
            'numero_convention': 'AFD-BF-2024-EDUC-001',
            'libelle': 'Financement projet √©ducation rurale - Phase 1',
            'montant_accorde': Decimal('2000000000'),
            'montant_decaisse': Decimal('800000000'),
            'montant_utilise': Decimal('600000000'),
            'date_signature': date(2023, 12, 15),
            'date_debut': date(2024, 1, 1),
            'date_fin': date(2026, 12, 31),
            'conditions_decaissement': 'D√©caissement par tranches sur justification',
            'modalites_reporting': 'Rapports trimestriels + rapport annuel'
        },
        {
            'projet_id': projets[1].id,
            'bailleur_id': bailleurs[1].id,  # Gates
            'numero_convention': 'BMGF-2024-HEALTH-BF-002',
            'libelle': 'Subvention sant√© communautaire',
            'montant_accorde': Decimal('1600000000'),
            'montant_decaisse': Decimal('400000000'),
            'montant_utilise': Decimal('300000000'),
            'date_signature': date(2024, 2, 1),
            'date_debut': date(2024, 3, 1),
            'date_fin': date(2027, 2, 28),
            'conditions_decaissement': 'D√©caissement sur atteinte d\'indicateurs',
            'modalites_reporting': 'Rapports semestriels + √©valuation externe'
        },
        {
            'projet_id': projets[2].id,
            'bailleur_id': bailleurs[2].id,  # UE
            'numero_convention': 'EU-BF-2024-AGRI-003',
            'libelle': 'Programme d√©veloppement agricole durable',
            'montant_accorde': Decimal('2800000000'),
            'montant_decaisse': Decimal('700000000'),
            'montant_utilise': Decimal('500000000'),
            'date_signature': date(2024, 5, 1),
            'date_debut': date(2024, 6, 1),
            'date_fin': date(2028, 5, 31),
            'conditions_decaissement': 'Avance + d√©caissement sur justificatifs',
            'modalites_reporting': 'Rapports techniques et financiers trimestriels'
        }
    ]
    
    financements = []
    for data in financements_data:
        financement = Financement(association_id=association_id, **data)
        db.session.add(financement)
        financements.append(financement)
    
    db.session.flush()
    
    for financement in financements:
        # R√©cup√©rer le bailleur et projet manuellement
        bailleur = next((b for b in bailleurs if b.id == financement.bailleur_id), None)
        projet = next((p for p in projets if p.id == financement.projet_id), None)
        
        taux_decaissement = (financement.montant_decaisse / financement.montant_accorde) * 100
        taux_utilisation = (financement.montant_utilise / financement.montant_decaisse) * 100 if financement.montant_decaisse > 0 else 0
        
        print(f"‚úÖ Financement: {financement.numero_convention}")
        print(f"   üèõÔ∏è Bailleur: {bailleur.nom if bailleur else 'N/A'}")
        print(f"   üöÄ Projet: {projet.code_projet if projet else 'N/A'}")
        print(f"   üí∞ Accord√©: {float(financement.montant_accorde):,.0f} FCFA")
        print(f"   üì• D√©caiss√©: {float(financement.montant_decaisse):,.0f} FCFA ({taux_decaissement:.1f}%)")
        print(f"   üìä Utilis√©: {float(financement.montant_utilise):,.0f} FCFA ({taux_utilisation:.1f}%)")
        print(f"   üìÖ P√©riode: {financement.date_debut} ‚Üí {financement.date_fin}")
        print()
    
    return financements

def generer_statistiques_globales(association_id, dirigeants, projets, budgets, activites, biens, financements):
    """G√©n√®re des statistiques globales"""
    print("\nüìä STATISTIQUES GLOBALES DE L'ASSOCIATION")
    print("=" * 60)
    
    # Dirigeants
    dirigeants_actifs = [d for d in dirigeants if d.statut == StatutDirigeant.ACTIF]
    print(f"üë• DIRIGEANTS:")
    print(f"   Total: {len(dirigeants)} | Actifs: {len(dirigeants_actifs)}")
    
    # Projets
    projets_actifs = [p for p in projets if p.statut == StatutProjet.EN_COURS]
    print(f"üöÄ PROJETS:")
    print(f"   Total: {len(projets)} | Actifs: {len(projets_actifs)}")
    budget_total_projets = sum(float(p.budget_total) for p in projets)
    print(f"   Budget total: {budget_total_projets:,.0f} FCFA")
    
    # Bailleurs
    bailleurs_uniques = list(set(p.bailleur_id for p in projets if p.bailleur_id))
    print(f"üèõÔ∏è PARTENAIRES BAILLEURS: {len(bailleurs_uniques)}")
    
    # Budgets
    print(f"üí∞ BUDGETS:")
    budget_total_prevu = sum(float(b.total_recettes_prevues or 0) for b in budgets)
    budget_total_realise = sum(float(b.total_recettes_realisees or 0) for b in budgets)
    print(f"   Budgets cr√©√©s: {len(budgets)}")
    print(f"   Recettes pr√©vues: {budget_total_prevu:,.0f} FCFA")
    print(f"   Recettes r√©alis√©es: {budget_total_realise:,.0f} FCFA")
    
    # Activit√©s
    print(f"üéØ ACTIVIT√âS:")
    print(f"   Total: {len(activites)}")
    activites_par_type = {}
    for activite in activites:
        type_act = activite.type_activite.value
        activites_par_type[type_act] = activites_par_type.get(type_act, 0) + 1
    for type_act, count in activites_par_type.items():
        print(f"   {type_act.title()}: {count}")
    
    # Patrimoine
    print(f"üèõÔ∏è PATRIMOINE:")
    print(f"   Nombre de biens: {len(biens)}")
    valeur_patrimoine = sum(float(b.valeur_actuelle or b.valeur_acquisition or 0) for b in biens)
    print(f"   Valeur totale: {valeur_patrimoine:,.0f} FCFA")
    
    # Financements
    print(f"üí∏ FINANCEMENTS:")
    print(f"   Nombre de financements: {len(financements)}")
    montant_total_accorde = sum(float(f.montant_accorde) for f in financements)
    montant_total_decaisse = sum(float(f.montant_decaisse) for f in financements)
    montant_total_utilise = sum(float(f.montant_utilise) for f in financements)
    print(f"   Total accord√©: {montant_total_accorde:,.0f} FCFA")
    print(f"   Total d√©caiss√©: {montant_total_decaisse:,.0f} FCFA ({(montant_total_decaisse/montant_total_accorde)*100:.1f}%)")
    print(f"   Total utilis√©: {montant_total_utilise:,.0f} FCFA ({(montant_total_utilise/montant_total_decaisse)*100:.1f}%)")
    
    print("\nüéØ INDICATEURS CL√âS:")
    print(f"   ‚Ä¢ Taux d'activit√© projets: {len(projets_actifs)/len(projets)*100:.1f}%")
    print(f"   ‚Ä¢ Diversification bailleurs: {len(bailleurs_uniques)} partenaires")
    print(f"   ‚Ä¢ Taux de d√©caissement: {(montant_total_decaisse/montant_total_accorde)*100:.1f}%")
    print(f"   ‚Ä¢ Taux d'utilisation: {(montant_total_utilise/montant_total_decaisse)*100:.1f}%")

def main():
    """Fonction principale de test"""
    print("üèõÔ∏è TEST SYST√àME GESTION AVANC√âE COMPTAEBNL-IA")
    print("=" * 70)
    print("Test complet : Dirigeants, Projets, Budget, Activit√©s, Patrimoine, Balance")
    print("Architecture multi-projets et multi-bailleurs pour EBNL OHADA")
    print()
    
    try:
        with app.app_context():
            # Initialisation
            association_id, bailleurs = init_test_data()
            
            # Tests des modules
            dirigeants = test_dirigeants(association_id)
            projets = test_projets(association_id, bailleurs)
            budgets = test_budgets(association_id, projets)
            activites = test_activites(association_id, projets)
            biens = test_patrimoine(association_id, projets)
            financements = test_financements(association_id, projets, bailleurs)
            
            # Commit final
            db.session.commit()
            
            # Statistiques globales
            generer_statistiques_globales(
                association_id, dirigeants, projets, budgets, 
                activites, biens, financements
            )
            
            print("\nüéâ TOUS LES TESTS R√âUSSIS !")
            print("‚úÖ Syst√®me de gestion avanc√©e op√©rationnel")
            print("‚úÖ Architecture multi-projets et multi-bailleurs fonctionnelle")
            print("‚úÖ Gestion compl√®te des EBNL selon SYCEBNL")
            print("\nüí° Base de donn√©es de test cr√©√©e: test_gestion_avancee.db")
            
            return 0
            
    except Exception as e:
        print(f"\nüí• ERREUR LORS DES TESTS: {str(e)}")
        import traceback
        traceback.print_exc()
        return 1

if __name__ == '__main__':
    exit(main())